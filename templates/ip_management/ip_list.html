{% extends "shared/base_layout.html" %}

{% block title %}IP Management{% endblock %}
{% block page_title %}IP Management{% endblock %}
{% block page_subtitle %}View and manage IP addresses{% endblock %}

{% block header_actions %}
<button onclick="openAssignIPModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
    <i class="fas fa-plus mr-2"></i>Add IP
</button>
<button onclick="loadPageData()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
    <i class="fas fa-sync mr-2"></i>Refresh
</button>
{% endblock %}

{% block content %}
<!-- Filter Controls -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search IPs</label>
                <input type="text" id="ip-search" placeholder="Search by IP or hostname..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status Filter</label>
                <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Status</option>
                    <option value="used">Used</option>
                    <option value="available">Available</option>
                    <option value="reserved">Reserved</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">VRF/VPN Filter</label>
                <select id="vrf-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All VRF/VPN</option>
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="clearFilters()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-times mr-2"></i>Clear Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- IP List -->
<div class="bg-white rounded-lg shadow">
    <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900">IP Address List</h3>
            <div class="flex items-center space-x-3">
                <span class="text-sm text-gray-500" id="ip-count">Loading...</span>
                <div class="flex items-center space-x-1">
                    <button onclick="changePageSize(25)" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded" id="size-25">25</button>
                    <button onclick="changePageSize(50)" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded" id="size-50">50</button>
                    <button onclick="changePageSize(100)" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded" id="size-100">100</button>
                </div>
            </div>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortBy('ip_address')">
                        IP Address
                        <i class="fas fa-sort ml-1" id="sort-ip_address"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortBy('status')">
                        Status
                        <i class="fas fa-sort ml-1" id="sort-status"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortBy('hostname')">
                        Hostname
                        <i class="fas fa-sort ml-1" id="sort-hostname"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subnet</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VRF/VPN</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortBy('updated_at')">
                        Last Updated
                        <i class="fas fa-sort ml-1" id="sort-updated_at"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="ip-table-body" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="7" class="text-center py-8">
                        <i class="fas fa-spinner loading-spinner text-2xl text-blue-600"></i>
                        <p class="mt-2 text-gray-600">Loading IP addresses...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="px-6 py-3 border-t border-gray-200 bg-gray-50">
        <div class="flex justify-between items-center">
            <div class="text-sm text-gray-500" id="pagination-info">-</div>
            <div class="flex space-x-2" id="pagination-controls">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add/Edit IP Modal -->
<div id="ip-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900" id="modal-title">Add IP Address</h3>
                    <button onclick="closeIPModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <form id="ip-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">IP Address</label>
                    <input type="text" id="modal-ip" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., 192.168.1.100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hostname</label>
                    <input type="text" id="modal-hostname"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., server01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="modal-status" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="used">Used</option>
                        <option value="available">Available</option>
                        <option value="reserved">Reserved</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">VRF/VPN</label>
                    <input type="text" id="modal-vrf"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., CINNAMON">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="modal-description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Optional description"></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save
                    </button>
                    <button type="button" onclick="closeIPModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentData = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = 50;
    let sortField = 'ip_address';
    let sortDirection = 'asc';
    let editingIP = null;

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadPageData();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Search input with debounce
        let searchTimeout;
        document.getElementById('ip-search').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        });

        // Filter selects
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('vrf-filter').addEventListener('change', applyFilters);

        // Form submission
        document.getElementById('ip-form').addEventListener('submit', handleIPSubmit);
    }

    async function loadPageData() {
        try {
            const response = await fetch('/api/ip-data');
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            currentData = data.data || [];
            populateVRFFilter();
            applyFilters();
            
        } catch (error) {
            console.error('Error loading IP data:', error);
            showToast('Failed to load IP data', 'error');
            document.getElementById('ip-table-body').innerHTML = 
                '<tr><td colspan="7" class="text-center py-8 text-red-500">Failed to load data</td></tr>';
        }
    }

    function populateVRFFilter() {
        const vrfFilter = document.getElementById('vrf-filter');
        const vrfs = [...new Set(currentData.filter(ip => ip.vrf_vpn).map(ip => ip.vrf_vpn))];
        
        vrfFilter.innerHTML = '<option value="">All VRF/VPN</option>' + 
            vrfs.map(vrf => `<option value="${vrf}">${vrf}</option>`).join('');
    }

    function applyFilters() {
        const search = document.getElementById('ip-search').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        const vrfFilter = document.getElementById('vrf-filter').value;

        filteredData = currentData.filter(ip => {
            const matchesSearch = !search || 
                ip.ip_address.toLowerCase().includes(search) ||
                (ip.hostname && ip.hostname.toLowerCase().includes(search));
            
            const matchesStatus = !statusFilter || ip.status === statusFilter;
            const matchesVRF = !vrfFilter || ip.vrf_vpn === vrfFilter;
            
            return matchesSearch && matchesStatus && matchesVRF;
        });

        // Sort data
        sortData();
        
        // Reset to first page
        currentPage = 1;
        renderTable();
    }

    function sortData() {
        filteredData.sort((a, b) => {
            let aVal = a[sortField] || '';
            let bVal = b[sortField] || '';
            
            // Special handling for IP addresses
            if (sortField === 'ip_address') {
                aVal = ipToNumber(aVal);
                bVal = ipToNumber(bVal);
            }
            
            if (sortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
    }

    function ipToNumber(ip) {
        return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0);
    }

    function sortBy(field) {
        if (sortField === field) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortField = field;
            sortDirection = 'asc';
        }
        
        // Update sort indicators
        document.querySelectorAll('[id^="sort-"]').forEach(icon => {
            icon.className = 'fas fa-sort ml-1';
        });
        
        const sortIcon = document.getElementById(`sort-${field}`);
        if (sortIcon) {
            sortIcon.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`;
        }
        
        applyFilters();
    }

    function renderTable() {
        const tbody = document.getElementById('ip-table-body');
        const startIdx = (currentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageData = filteredData.slice(startIdx, endIdx);

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No IP addresses found</td></tr>';
        } else {
            tbody.innerHTML = pageData.map(ip => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono">${ip.ip_address}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(ip.status)}">
                            ${ip.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ip.hostname || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ip.subnet || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ip.vrf_vpn || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(ip.updated_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="editIP('${ip.ip_address}')" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteIP('${ip.ip_address}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        updatePagination();
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / pageSize);
        const startItem = (currentPage - 1) * pageSize + 1;
        const endItem = Math.min(currentPage * pageSize, filteredData.length);
        
        document.getElementById('ip-count').textContent = 
            `Showing ${formatNumber(startItem)}-${formatNumber(endItem)} of ${formatNumber(filteredData.length)} IPs`;
        
        document.getElementById('pagination-info').textContent = 
            `Page ${currentPage} of ${totalPages}`;

        // Generate pagination controls
        const controls = document.getElementById('pagination-controls');
        let buttonsHTML = '';
        
        // Previous button
        buttonsHTML += `<button onclick="changePage(${currentPage - 1})" 
                               class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                               ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
        
        // Page numbers
        for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
            buttonsHTML += `<button onclick="changePage(${i})" 
                                   class="px-3 py-1 text-sm rounded ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}">${i}</button>`;
        }
        
        // Next button
        buttonsHTML += `<button onclick="changePage(${currentPage + 1})" 
                               class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                               ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
        
        controls.innerHTML = buttonsHTML;
    }

    function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / pageSize);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        renderTable();
    }

    function changePageSize(size) {
        pageSize = size;
        currentPage = 1;
        
        // Update active button
        document.querySelectorAll('[id^="size-"]').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
        document.getElementById(`size-${size}`).classList.add('bg-blue-600', 'text-white');
        
        renderTable();
    }

    function clearFilters() {
        document.getElementById('ip-search').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('vrf-filter').value = '';
        applyFilters();
        showToast('All filters cleared', 'success');
    }

    // Modal functions
    function openAssignIPModal() {
        editingIP = null;
        document.getElementById('modal-title').textContent = 'Add IP Address';
        document.getElementById('ip-form').reset();
        document.getElementById('modal-ip').disabled = false;
        document.getElementById('ip-modal').classList.remove('hidden');
    }

    function editIP(ipAddress) {
        const ip = currentData.find(item => item.ip_address === ipAddress);
        if (!ip) return;
        
        editingIP = ipAddress;
        document.getElementById('modal-title').textContent = 'Edit IP Address';
        document.getElementById('modal-ip').value = ip.ip_address;
        document.getElementById('modal-ip').disabled = true;
        document.getElementById('modal-hostname').value = ip.hostname || '';
        document.getElementById('modal-status').value = ip.status || '';
        document.getElementById('modal-vrf').value = ip.vrf_vpn || '';
        document.getElementById('modal-description').value = ip.description || '';
        document.getElementById('ip-modal').classList.remove('hidden');
    }

    function closeIPModal() {
        document.getElementById('ip-modal').classList.add('hidden');
        editingIP = null;
    }

    async function handleIPSubmit(e) {
        e.preventDefault();
        
        const formData = {
            ip_address: document.getElementById('modal-ip').value,
            hostname: document.getElementById('modal-hostname').value,
            status: document.getElementById('modal-status').value,
            vrf_vpn: document.getElementById('modal-vrf').value,
            description: document.getElementById('modal-description').value
        };

        try {
            const url = editingIP ? `/api/ip-data/${editingIP}` : '/api/ip-data';
            const method = editingIP ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }

            showToast(`IP ${editingIP ? 'updated' : 'added'} successfully`, 'success');
            closeIPModal();
            loadPageData();
            
        } catch (error) {
            console.error('Error saving IP:', error);
            showToast(`Failed to ${editingIP ? 'update' : 'add'} IP: ${error.message}`, 'error');
        }
    }

    async function deleteIP(ipAddress) {
        if (!confirm(`Are you sure you want to delete IP ${ipAddress}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/ip-data/${ipAddress}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }

            showToast('IP deleted successfully', 'success');
            loadPageData();
            
        } catch (error) {
            console.error('Error deleting IP:', error);
            showToast(`Failed to delete IP: ${error.message}`, 'error');
        }
    }

    // Initialize page size button
    document.getElementById('size-50').classList.add('bg-blue-600', 'text-white');
</script>
{% endblock %}
